{% extends "templates/web.html" %}

<!-- Label Creator v2.6.0 - Updated: 2026-01-09 - Cache Buster: 20260109010000 -->

{% block title %}{{ title }}{% endblock %}

{% block page_content %}
<div class="container mt-4" style="max-width: 1200px;">
    <div class="row">
        <div class="col-md-12">
            <h1 class="mb-4">Label Creator</h1>
            <p class="text-muted">Upload CSV files to generate product labels with QR codes</p>
        </div>
    </div>

    <div class="row mt-2 mb-3">
        <div class="col-md-12">
            <a href="#" id="downloadTemplateLink" class="text-primary" style="text-decoration: none;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download me-1" viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                </svg>
                Download Template File
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Upload CSV Files</h5>

                    <div class="upload-area p-4 text-center border rounded" style="border-style: dashed !important; background-color: #f8f9fa;">
                        <input type="file" id="fileInput" multiple accept=".csv" style="display: none;">
                        <label for="fileInput" style="cursor: pointer; margin: 0;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-cloud-upload mb-3" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383z"/>
                                <path fill-rule="evenodd" d="M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3z"/>
                            </svg>
                            <h5>Choose CSV Files</h5>
                            <p class="text-muted">or drag and drop here</p>
                        </label>
                    </div>

                    <div id="fileList" class="mt-3"></div>

                    <button id="uploadBtn" class="btn btn-primary mt-3" style="display: none;">
                        Process Files
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Section -->
    <div id="previewSection" class="row mt-4" style="display: none;">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Label Preview</h5>
                    <p>Total Labels: <strong id="totalLabels">0</strong></p>

                    <div class="row mb-3 align-items-start">
                        <div class="col-md-4">
                            <label for="labelType" class="form-label">Label Type</label>
                            <select id="labelType" class="form-select">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <div>
                                <button id="generateBtn" class="btn btn-success me-2">
                                    Generate Labels (PDF)
                                </button>
                                <button id="startOverBtn" class="btn btn-secondary">
                                    Start Over
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Single Label Preview - inline, below selector -->
                    <div class="row mb-3" id="singleLabelPreviewSection" style="display: none;">
                        <div class="col-md-12">
                            <div class="d-flex align-items-center gap-3">
                                <div id="singleLabelPreview" class="text-center" style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; background-color: #f8f9fa; min-width: 120px; min-height: 120px; display: flex; align-items: center; justify-content: center;">
                                    <div class="text-muted">Loading...</div>
                                </div>
                                <div>
                                    <p class="mb-2 text-muted" style="font-size: 14px;">Single label preview</p>
                                    <button id="openPagePreviewBtn" class="btn btn-outline-primary btn-sm">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-grid me-1" viewBox="0 0 16 16">
                                            <path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zM1 10.5A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3z"/>
                                        </svg>
                                        Open Sample Page Preview
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped" id="previewTable">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">
                                        <input type="checkbox" id="selectAll" checked>
                                    </th>
                                    <th style="width: 100px;">Preview</th>
                                    <th>SKU</th>
                                    <th>Product</th>
                                    <th style="width: 150px;">Price</th>
                                    <th style="width: 120px;">Quantity</th>
                                </tr>
                            </thead>
                            <tbody id="previewTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Section -->
    <div id="errorSection" class="row mt-4" style="display: none;">
        <div class="col-md-12">
            <div class="alert alert-danger" role="alert">
                <h4 class="alert-heading">❌ Error Processing File</h4>
                <p id="errorMessage" style="white-space: pre-wrap;"></p>
                <hr>
                <button id="tryAgainBtn" class="btn btn-danger">
                    Try Again
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="row mt-4" style="display: none;">
        <div class="col-md-12 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Processing...</p>
        </div>
    </div>

    <!-- Success Section -->
    <div id="successSection" class="row mt-4" style="display: none;">
        <div class="col-md-12">
            <div class="alert alert-success" role="alert">
                <h4 class="alert-heading">✅ Labels Generated Successfully!</h4>
                <p>Your PDF file has been downloaded automatically. If the download didn't start, click the button below.</p>
                <hr>
                <div class="d-flex gap-2">
                    <a id="downloadLink" href="#" class="btn btn-success" download>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                        </svg>
                        Download Again
                    </a>
                    <button id="generateAnotherBtn" class="btn btn-primary">
                        Go Back
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sample Page Preview Modal -->
    <div class="modal fade" id="pagePreviewModal" tabindex="-1" aria-labelledby="pagePreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pagePreviewModalLabel">Sample Page Preview</h5>
                    <button type="button" class="btn-close" onclick="closePagePreviewModal()" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center" style="max-height: 70vh; overflow-y: auto;">
                    <div id="pagePreviewContent">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Generating preview...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closePagePreviewModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Version Footer -->
    <footer class="mt-5 pt-4 border-top">
        <div class="row">
            <div class="col-md-12 text-center text-muted">
                <small>Label Creator v2.6.0 | Last Updated: 2026-01-24</small>
            </div>
        </div>
    </footer>
</div>

{% block style %}
<style>
.upload-area {
    transition: background-color 0.3s;
}
.upload-area:hover {
    background-color: #e9ecef !important;
}
.card {
    box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    border: 1px solid #e8e9ea;
}

/* Editable input styling */
.price-input, .quantity-input {
    background-color: white !important;
    border: 1px solid black !important;
    border-radius: 3px;
    padding: 4px 8px;
}

/* Make $ symbol blend with the row */
.input-group-text {
    background-color: transparent !important;
    border: none !important;
    padding-left: 0;
    padding-right: 4px;
    color: inherit;
}

.input-group {
    border: none !important;
    background: transparent !important;
}

/* Remove Bootstrap's input-group borders */
.input-group > .form-control {
    border-radius: 3px !important;
}

/* SKU column word wrapping - break on hyphens and word boundaries */
#previewTable tbody td:nth-child(3) {
    overflow-wrap: anywhere;
    word-break: normal;
    white-space: normal;
    max-width: 200px;
    min-width: 80px;
}

/* Label preview cell styling */
.label-preview-cell {
    text-align: center;
    vertical-align: middle;
    padding: 8px !important;
}

.label-preview-cell img {
    display: inline-block;
    object-fit: contain;
}

/* Single label preview styling */
#singleLabelPreview {
    min-width: 120px;
    min-height: 120px;
    max-width: 200px;
}

#singleLabelPreview img {
    max-width: 150px;
    max-height: 150px;
    object-fit: contain;
}

#singleLabelPreview.loading {
    opacity: 0.6;
}

/* Page preview modal styling */
#pagePreviewContent img {
    max-width: 100%;
    height: auto;
    border: 1px solid #ddd;
    border-radius: 4px;
}

#pagePreviewContent .error-state {
    color: #dc3545;
    padding: 20px;
}

/* Hide the "Get Updates" newsletter box from footer */
.footer-subscribe,
.newsletter-subscribe,
.web-footer .footer-subscribe-section,
footer .subscribe-footer,
.footer-powered + div,
.web-footer form,
[data-section="newsletter"] {
    display: none !important;
}
</style>
{% endblock %}

{% raw %}
<script>
let processedContent = [];

// Helper function to escape HTML to prevent XSS attacks
function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    var div = document.createElement('div');
    div.textContent = String(text);
    return div.innerHTML;
}

// Function to download CSV template file
function downloadTemplateCSV() {
    // CSV header and sample data rows
    var csvContent = 'product,sku,quantity,display_price\n';
    csvContent += 'Widget Pro 2000,WGT-PRO-2000,10,29.99\n';
    csvContent += 'Super Gadget XL,SGT-XL-001,5,49.99\n';
    csvContent += 'Mini Tool Kit,MTK-BASIC-100,25,14.99\n';
    csvContent += 'Premium Cable 6ft,CBL-PRM-6FT,50,9.99\n';
    csvContent += 'Deluxe Case Black,CSE-DLX-BLK,15,19.99\n';

    // Create blob and trigger download
    var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    var link = document.createElement('a');
    var url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'label_template.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

// Add click handler for template download link
document.addEventListener('DOMContentLoaded', function() {
    var templateLink = document.getElementById('downloadTemplateLink');
    if (templateLink) {
        templateLink.addEventListener('click', function(e) {
            e.preventDefault();
            downloadTemplateCSV();
        });
    }
});

// Ensure frappe is available
if (typeof frappe === 'undefined') {
    window.frappe = {
        call: function(opts) {
            const formData = new FormData();
            for (const key in opts.args) {
                formData.append(key, opts.args[key]);
            }

            fetch('/api/method/' + opts.method, {
                method: 'POST',
                headers: {
                    'X-Frappe-CSRF-Token': frappe.csrf_token || ''
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (opts.callback) {
                    opts.callback(data);
                }
            })
            .catch(error => {
                if (opts.error) {
                    opts.error(error);
                }
                console.error('Error:', error);
            });
        },
        msgprint: function(msg) {
            alert(msg);
        },
        csrf_token: document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
    };
}

// Load label types on page load
document.addEventListener('DOMContentLoaded', function() {
    loadLabelTypes();
});

let labelTypesData = {};

function loadLabelTypes() {
    frappe.call({
        method: 'label_creator.api.labels.get_label_types',
        args: {},
        callback: function(response) {
            if (response.message && response.message.success) {
                labelTypesData = response.message.label_types;
                const select = document.getElementById('labelType');
                select.innerHTML = '';

                for (const [key, value] of Object.entries(labelTypesData)) {
                    const option = document.createElement('option');
                    option.value = key;
                    // Use the 'name' field if available, otherwise show key with dimensions
                    const displayName = value.name || `${key} (${value.labels_per_row}x${value.labels_per_column})`;
                    option.textContent = displayName;
                    select.appendChild(option);
                }

                // Add event listener to show preview when label type changes
                select.addEventListener('change', function() {
                    if (this.value) {
                        loadSingleLabelPreviewForType(this.value);
                        // Refresh row previews if data is loaded
                        if (processedContent.length > 0) {
                            refreshRowPreviews();
                        }
                    } else {
                        document.getElementById('singleLabelPreviewSection').style.display = 'none';
                    }
                });

                // Load preview for first option if available
                if (Object.keys(labelTypesData).length > 0) {
                    const firstKey = Object.keys(labelTypesData)[0];
                    select.value = firstKey;
                    loadSingleLabelPreviewForType(firstKey);
                }

                // Add event listener for the page preview button
                document.getElementById('openPagePreviewBtn').addEventListener('click', openPagePreviewModal);
            }
        },
        error: function(error) {
            console.error('Error loading label types:', error);
            alert('Error loading label types');
        }
    });
}

function loadSingleLabelPreviewForType(labelTypeName) {
    console.log('Loading single label preview for type:', labelTypeName);

    if (!labelTypeName) {
        console.error('No label type name provided');
        return;
    }

    var previewSection = document.getElementById('singleLabelPreviewSection');
    var previewContainer = document.getElementById('singleLabelPreview');

    // Show preview section with loading state
    previewSection.style.display = 'block';
    previewContainer.classList.add('loading');
    previewContainer.innerHTML = '<div class="text-muted">Loading...</div>';

    // Get sample data from label type configuration
    var labelConfig = labelTypesData[labelTypeName] || {};
    var sampleSku = (labelConfig && labelConfig.sku_sample) ? labelConfig.sku_sample : 'SAM-PLE-SKU';
    var sampleProduct = (labelConfig && labelConfig.product_name_sample) ? labelConfig.product_name_sample : 'Sample Product Name';
    var samplePrice = (labelConfig && labelConfig.price_sample) ? labelConfig.price_sample : 29.99;

    frappe.call({
        method: 'label_creator.api.labels.preview_single_label',
        args: {
            label_type: labelTypeName,
            sku: sampleSku,
            product_name: sampleProduct,
            price: String(samplePrice)
        },
        callback: function(response) {
            console.log('Single label preview response:', response);

            previewContainer.classList.remove('loading');

            if (response.message && response.message.success) {
                if (response.message.image_type === 'png' && response.message.image_data) {
                    var img = document.createElement('img');
                    img.src = 'data:image/png;base64,' + response.message.image_data;
                    img.alt = 'Label Preview';
                    previewContainer.innerHTML = '';
                    previewContainer.appendChild(img);
                    console.log('Loaded PNG preview for single label');
                } else if (response.message.pdf_data) {
                    // PDF can't be displayed in img tag - show placeholder with message
                    previewContainer.innerHTML = '<div class="text-muted" style="font-size: 12px;"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-file-earmark-pdf mb-2" viewBox="0 0 16 16"><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/><path d="M4.603 14.087a.81.81 0 0 1-.438-.42c-.195-.388-.13-.776.08-1.102.198-.307.526-.568.897-.787a7.68 7.68 0 0 1 1.482-.645 19.697 19.697 0 0 0 1.062-2.227 7.269 7.269 0 0 1-.43-1.295c-.086-.4-.119-.796-.046-1.136.075-.354.274-.672.65-.823.192-.077.4-.12.602-.077a.7.7 0 0 1 .477.365c.088.164.12.356.127.538.007.188-.012.396-.047.614-.084.51-.27 1.134-.52 1.794a10.954 10.954 0 0 0 .98 1.686 5.753 5.753 0 0 1 1.334.05c.364.066.734.195.96.465.12.144.193.32.2.518.007.192-.047.382-.138.563a1.04 1.04 0 0 1-.354.416.856.856 0 0 1-.51.138c-.331-.014-.654-.196-.933-.417a5.712 5.712 0 0 1-.911-.95 11.651 11.651 0 0 0-1.997.406 11.307 11.307 0 0 1-1.02 1.51c-.292.35-.609.656-.927.787a.793.793 0 0 1-.58.029z"/></svg><br>Preview generated<br><small>(PDF format)</small></div>';
                    console.log('PDF preview - showing placeholder');
                } else {
                    previewContainer.innerHTML = '<div class="text-danger" style="font-size: 12px;">No preview data</div>';
                }
            } else {
                console.error('Single label preview failed:', response.message);
                var errorMsg = (response.message && response.message.message) ? response.message.message : 'Preview failed';
                previewContainer.innerHTML = '<div class="text-danger" style="font-size: 12px;">Preview failed</div>';
                previewContainer.title = errorMsg;
            }
        },
        error: function(error) {
            console.error('Error loading single label preview:', error);
            previewContainer.classList.remove('loading');
            previewContainer.innerHTML = '<div class="text-danger" style="font-size: 12px;">Error loading</div>';
        }
    });
}

function openPagePreviewModal() {
    const labelTypeName = document.getElementById('labelType').value;
    if (!labelTypeName) {
        alert('Please select a label type first');
        return;
    }

    const previewContent = document.getElementById('pagePreviewContent');
    const modalElement = document.getElementById('pagePreviewModal');

    // Show loading state
    previewContent.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2 text-muted">Generating preview...</p>';

    // Show the modal manually (without Bootstrap JS dependency)
    modalElement.classList.add('show');
    modalElement.style.display = 'block';
    document.body.classList.add('modal-open');

    // Create backdrop
    let backdrop = document.querySelector('.modal-backdrop');
    if (!backdrop) {
        backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        document.body.appendChild(backdrop);
    }

    // Load the full page preview
    frappe.call({
        method: 'label_creator.api.labels.preview_label',
        args: {
            label_type_name: labelTypeName
        },
        callback: function(response) {
            console.log('Page preview response:', response);

            if (response.message && response.message.success) {
                if (response.message.image_type === 'png' && response.message.image_data) {
                    var img = document.createElement('img');
                    img.src = 'data:image/png;base64,' + response.message.image_data;
                    img.alt = 'Sample Page Preview';
                    img.style.maxWidth = '100%';
                    previewContent.innerHTML = '';
                    previewContent.appendChild(img);
                    console.log('Loaded PNG page preview');
                } else if (response.message.pdf_data) {
                    // For PDF, use an embed element
                    previewContent.innerHTML = '<embed src="data:application/pdf;base64,' + response.message.pdf_data + '" type="application/pdf" width="100%" height="500px" /><p class="mt-2 text-muted"><small>If the preview does not display, your browser may not support inline PDF viewing.</small></p>';
                    console.log('Loaded PDF page preview');
                } else {
                    previewContent.innerHTML = '<div class="error-state">No preview data available</div>';
                }
            } else {
                var errorMsg = (response.message && response.message.message) ? response.message.message : 'Unknown error';
                previewContent.innerHTML = '<div class="error-state">Failed to generate preview: ' + escapeHtml(errorMsg) + '</div>';
                console.error('Page preview failed:', errorMsg);
            }
        },
        error: function(error) {
            console.error('Error loading page preview:', error);
            previewContent.innerHTML = '<div class="error-state">Error loading preview. Please try again.</div>';
        }
    });
}

function closePagePreviewModal() {
    var modalElement = document.getElementById('pagePreviewModal');
    modalElement.classList.remove('show');
    modalElement.style.display = 'none';
    document.body.classList.remove('modal-open');

    var backdrop = document.querySelector('.modal-backdrop');
    if (backdrop) {
        backdrop.remove();
    }
}

// File input handling
const fileInput = document.getElementById('fileInput');
const uploadBtn = document.getElementById('uploadBtn');
const fileList = document.getElementById('fileList');

fileInput.addEventListener('change', function() {
    if (this.files.length > 0) {
        fileList.innerHTML = '<ul class="list-group"></ul>';
        const ul = fileList.querySelector('ul');

        Array.from(this.files).forEach(file => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = file.name;
            ul.appendChild(li);
        });

        uploadBtn.style.display = 'block';
    } else {
        fileList.innerHTML = '';
        uploadBtn.style.display = 'none';
    }
});

// Upload and process
uploadBtn.addEventListener('click', function() {
    const files = fileInput.files;
    if (files.length === 0) return;

    document.getElementById('loadingSpinner').style.display = 'block';

    const filesData = [];
    let filesRead = 0;

    Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
            filesData.push({
                filename: file.name,
                content: e.target.result
            });
            filesRead++;

            if (filesRead === files.length) {
                // All files read, now upload
                frappe.call({
                    method: 'label_creator.api.labels.upload_and_process',
                    args: {
                        files_json: JSON.stringify(filesData)
                    },
                    callback: function(response) {
                        document.getElementById('loadingSpinner').style.display = 'none';

                        console.log('Upload response received:', response);

                        // First, check if response and response.message exist
                        if (!response || !response.message) {
                            console.error('Invalid response structure:', response);
                            showError('Server returned invalid response. Please check the Error Log.');
                            return;
                        }

                        // Check if response.message is a string (might be HTML error)
                        if (typeof response.message === 'string') {
                            console.error('Response message is a string (possibly HTML error):', response.message);
                            // Check if it looks like HTML
                            if (response.message.includes('<html>') || response.message.includes('<!DOCTYPE')) {
                                showError('Server returned an HTML error page. Please check the Error Log for details.');
                            } else {
                                showError('Error: ' + response.message);
                            }
                            return;
                        }

                        if (response.message.success) {
                            // Validate that processed_content exists and is an array
                            if (!response.message.processed_content) {
                                console.error('Missing processed_content in response');
                                showError('Server response is missing product data.');
                                return;
                            }

                            if (!Array.isArray(response.message.processed_content)) {
                                console.error('Invalid processed_content - not an array:', response.message.processed_content);
                                showError('Server returned invalid data format. Expected array, got: ' + typeof response.message.processed_content);
                                return;
                            }

                            // Validate that each item has required fields
                            const invalidItems = response.message.processed_content.filter(item =>
                                !item || typeof item !== 'object' || !item.sku || !item.product
                            );

                            if (invalidItems.length > 0) {
                                console.error('Invalid items in processed_content:', invalidItems);
                                showError(`Found ${invalidItems.length} invalid item(s) in product data. Please check the Error Log.`);
                                return;
                            }

                            // Extra validation: check for HTML in item values
                            const htmlPattern = /<[^>]+>/;
                            const itemsWithHtml = response.message.processed_content.filter(item =>
                                htmlPattern.test(String(item.sku)) ||
                                htmlPattern.test(String(item.product)) ||
                                htmlPattern.test(String(item.display_price))
                            );

                            if (itemsWithHtml.length > 0) {
                                console.error('Items contain HTML:', itemsWithHtml);
                                showError('Product data contains HTML content. Server may have returned an error page.');
                                return;
                            }

                            console.log('Validation passed. Processing', response.message.processed_content.length, 'items');
                            processedContent = response.message.processed_content;
                            displayPreview(processedContent, response.message.total_labels);
                        } else {
                            const errorMsg = response.message.message || 'Unknown error processing files';
                            console.error('Upload processing failed:', errorMsg);
                            showError(errorMsg);
                        }
                    },
                    error: function(error) {
                        document.getElementById('loadingSpinner').style.display = 'none';
                        console.error('Upload error:', error);
                        showError('Error uploading files: ' + (error.message || 'Network error'));
                    }
                });
            }
        };
        reader.readAsText(file);
    });
});

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorSection').style.display = 'block';
    document.getElementById('errorSection').scrollIntoView({ behavior: 'smooth' });
}

function displayPreview(content, totalLabels) {
    document.getElementById('errorSection').style.display = 'none';
    document.getElementById('totalLabels').textContent = totalLabels;

    var tbody = document.getElementById('previewTableBody');
    tbody.innerHTML = '';

    for (var i = 0; i < content.length; i++) {
        var item = content[i];
        var index = i;

        var tr = document.createElement('tr');
        tr.setAttribute('data-index', String(index));

        // Checkbox cell
        var cbCell = document.createElement('td');
        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'item-checkbox';
        checkbox.setAttribute('data-index', String(index));
        checkbox.checked = true;
        cbCell.appendChild(checkbox);
        tr.appendChild(cbCell);

        // Preview cell
        var previewCell = document.createElement('td');
        previewCell.className = 'label-preview-cell';
        previewCell.setAttribute('data-index', String(index));
        previewCell.innerHTML = '<div class="text-muted" style="font-size: 12px;">Loading...</div>';
        tr.appendChild(previewCell);

        // SKU cell
        var skuCell = document.createElement('td');
        skuCell.textContent = item.sku;
        tr.appendChild(skuCell);

        // Product cell
        var productCell = document.createElement('td');
        productCell.textContent = item.product;
        tr.appendChild(productCell);

        // Price cell
        var priceCell = document.createElement('td');
        var priceGroup = document.createElement('div');
        priceGroup.className = 'input-group input-group-sm';

        var dollarSign = document.createElement('span');
        dollarSign.className = 'input-group-text';
        dollarSign.textContent = '$';

        var priceInput = document.createElement('input');
        priceInput.type = 'number';
        priceInput.className = 'form-control price-input';
        priceInput.setAttribute('data-index', String(index));
        priceInput.value = parseFloat(item.display_price).toFixed(2);
        priceInput.step = '0.05';
        priceInput.min = '0';
        priceInput.style.maxWidth = '100px';

        priceGroup.appendChild(dollarSign);
        priceGroup.appendChild(priceInput);
        priceCell.appendChild(priceGroup);
        tr.appendChild(priceCell);

        // Quantity cell
        var qtyCell = document.createElement('td');
        var qtyInput = document.createElement('input');
        qtyInput.type = 'number';
        qtyInput.className = 'form-control form-control-sm quantity-input';
        qtyInput.setAttribute('data-index', String(index));
        qtyInput.value = item.quantity;
        qtyInput.min = '1';
        qtyInput.style.maxWidth = '80px';
        qtyCell.appendChild(qtyInput);
        tr.appendChild(qtyCell);

        tbody.appendChild(tr);
    }

    // Update total when checkboxes or quantities change
    updateTotalLabels();

    // Add event listeners for checkboxes
    var checkboxes = document.querySelectorAll('.item-checkbox');
    for (var j = 0; j < checkboxes.length; j++) {
        checkboxes[j].addEventListener('change', updateTotalLabels);
    }

    // Add event listeners for quantity inputs
    var qtyInputs = document.querySelectorAll('.quantity-input');
    for (var k = 0; k < qtyInputs.length; k++) {
        qtyInputs[k].addEventListener('input', updateTotalLabels);
    }

    // Add event listeners to price inputs to refresh preview when price changes
    var priceInputs = document.querySelectorAll('.price-input');
    for (var m = 0; m < priceInputs.length; m++) {
        priceInputs[m].addEventListener('change', function() {
            var idx = this.getAttribute('data-index');
            var itm = processedContent[idx];
            if (itm) {
                loadSingleLabelPreview(idx, itm.sku, itm.product, this.value);
            }
        });
    }

    // Select/deselect all checkbox
    var selectAllCheckbox = document.getElementById('selectAll');
    selectAllCheckbox.checked = true;
    selectAllCheckbox.addEventListener('change', function() {
        var cbs = document.querySelectorAll('.item-checkbox');
        for (var n = 0; n < cbs.length; n++) {
            cbs[n].checked = this.checked;
        }
        updateTotalLabels();
    });

    document.getElementById('previewSection').style.display = 'block';
    window.scrollTo(0, document.body.scrollHeight);

    // Load individual label previews for each row
    refreshRowPreviews();
}

function loadSingleLabelPreview(index, sku, productName, price) {
    var labelType = document.getElementById('labelType').value;
    if (!labelType) {
        console.warn('No label type selected');
        return;
    }

    console.log('Loading preview for index ' + index + ': ' + sku + ', ' + productName + ', $' + price);

    var previewCell = document.querySelector('.label-preview-cell[data-index="' + index + '"]');
    if (previewCell) {
        previewCell.innerHTML = '<div class="text-muted" style="font-size: 12px;">Loading...</div>';
    }

    frappe.call({
        method: 'label_creator.api.labels.preview_single_label',
        args: {
            label_type: labelType,
            sku: sku,
            product_name: productName,
            price: String(price)
        },
        callback: function(response) {
            console.log('Preview response for index ' + index + ':', response);

            var cell = document.querySelector('.label-preview-cell[data-index="' + index + '"]');
            if (!cell) {
                console.warn('Preview cell not found for index ' + index);
                return;
            }

            if (response.message && response.message.success) {
                if (response.message.image_type === 'png' && response.message.image_data) {
                    var img = document.createElement('img');
                    img.style.maxWidth = '80px';
                    img.style.maxHeight = '80px';
                    img.style.border = '1px solid #ddd';
                    img.style.borderRadius = '4px';
                    img.alt = 'Label Preview';
                    img.src = 'data:image/png;base64,' + response.message.image_data;

                    cell.innerHTML = '';
                    cell.appendChild(img);
                    console.log('Preview loaded successfully for index ' + index);
                } else if (response.message.pdf_data) {
                    // PDF can't be displayed in img tag - show a small placeholder
                    cell.innerHTML = '<div class="text-muted" style="font-size: 10px;" title="PDF preview generated"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/></svg><br>OK</div>';
                    console.log('PDF preview for index ' + index + ' - showing placeholder');
                } else {
                    cell.innerHTML = '<div class="text-warning" style="font-size: 11px;">No data</div>';
                }
            } else {
                console.error('Preview failed for index ' + index + ':', response.message);
                if (response.message && response.message.traceback) {
                    console.error('Traceback:', response.message.traceback);
                }
                var errorMsg = (response.message && response.message.message) ? response.message.message : 'Unknown error';
                var errorDiv = document.createElement('div');
                errorDiv.className = 'text-danger';
                errorDiv.style.fontSize = '11px';
                errorDiv.title = String(errorMsg);  // Safe: title attribute is text, not HTML
                errorDiv.textContent = 'Error';
                cell.innerHTML = '';
                cell.appendChild(errorDiv);
                console.error('Full error for row ' + index + ':', errorMsg);
            }
        },
        error: function(error) {
            console.error('Error loading single label preview:', error);
            var cell = document.querySelector('.label-preview-cell[data-index="' + index + '"]');
            if (cell) {
                var errorDiv = document.createElement('div');
                errorDiv.className = 'text-danger';
                errorDiv.style.fontSize = '11px';
                errorDiv.title = error.message || 'Network error';  // Safe: title is text
                errorDiv.textContent = 'Error';
                cell.innerHTML = '';
                cell.appendChild(errorDiv);
            }
        }
    });
}

function refreshRowPreviews() {
    var labelType = document.getElementById('labelType').value;
    if (!labelType) {
        console.log('No label type selected, skipping row previews');
        return;
    }

    if (!Array.isArray(processedContent) || processedContent.length === 0) {
        console.log('No processed content available, skipping row previews');
        return;
    }

    console.log('Refreshing ' + processedContent.length + ' row previews with label type: ' + labelType);

    processedContent.forEach(function(item, index) {
        // Validate that item has required properties
        if (!item || typeof item !== 'object') {
            console.error('Invalid item at index ' + index + ':', item);
            return;
        }

        if (!item.sku || !item.product) {
            console.error('Missing sku or product at index ' + index + ':', item);
            return;
        }

        var priceInput = document.querySelector('.price-input[data-index="' + index + '"]');
        var price = priceInput ? priceInput.value : item.display_price;
        loadSingleLabelPreview(index, item.sku, item.product, price);
    });
}

function updateTotalLabels() {
    var total = 0;
    var checkedBoxes = document.querySelectorAll('.item-checkbox:checked');
    for (var i = 0; i < checkedBoxes.length; i++) {
        var idx = checkedBoxes[i].getAttribute('data-index');
        var quantityInput = document.querySelector('.quantity-input[data-index="' + idx + '"]');
        if (quantityInput) {
            total += parseInt(quantityInput.value) || 0;
        }
    }
    document.getElementById('totalLabels').textContent = total;
}

// Generate labels
document.getElementById('generateBtn').addEventListener('click', function() {
    var labelType = document.getElementById('labelType').value;

    if (!labelType) {
        alert('Please select a label type');
        return;
    }

    // Get selected items with updated prices and quantities
    var selectedItems = [];
    var checkedBoxes = document.querySelectorAll('.item-checkbox:checked');
    for (var i = 0; i < checkedBoxes.length; i++) {
        var idx = checkedBoxes[i].getAttribute('data-index');
        var priceInput = document.querySelector('.price-input[data-index="' + idx + '"]');
        var quantityInput = document.querySelector('.quantity-input[data-index="' + idx + '"]');

        var originalItem = processedContent[idx];
        var item = {
            sku: originalItem.sku,
            product: originalItem.product,
            display_price: parseFloat(priceInput.value).toFixed(2),
            quantity: parseInt(quantityInput.value) || 0
        };

        if (item.quantity > 0) {
            selectedItems.push(item);
        }
    }

    if (selectedItems.length === 0) {
        alert('Please select at least one item to print');
        return;
    }

    document.getElementById('loadingSpinner').style.display = 'block';

    frappe.call({
        method: 'label_creator.api.labels.generate_labels',
        args: {
            label_type: labelType,
            processed_content_json: JSON.stringify(selectedItems)
        },
        callback: function(response) {
            document.getElementById('loadingSpinner').style.display = 'none';

            if (response.message && response.message.success) {
                // Setup download link
                var downloadLink = document.getElementById('downloadLink');
                downloadLink.href = response.message.file_url;
                downloadLink.download = response.message.filename || 'labels.pdf';

                // Auto-trigger download
                downloadLink.click();

                // Show success section
                document.getElementById('successSection').style.display = 'block';
                document.getElementById('previewSection').style.display = 'none';

                // Scroll to success section
                document.getElementById('successSection').scrollIntoView({ behavior: 'smooth' });
            } else {
                var errorMsg = (response.message && response.message.message) ? response.message.message : 'Unknown error';
                alert('Error generating labels: ' + errorMsg);
            }
        },
        error: function(error) {
            document.getElementById('loadingSpinner').style.display = 'none';
            console.error('Generation error:', error);
            alert('Error generating labels');
        }
    });
});

// Start over
document.getElementById('startOverBtn').addEventListener('click', function() {
    location.reload();
});

// Generate another
document.getElementById('generateAnotherBtn').addEventListener('click', function() {
    document.getElementById('successSection').style.display = 'none';
    document.getElementById('previewSection').style.display = 'block';
    document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth' });
});

// Try again
document.getElementById('tryAgainBtn').addEventListener('click', function() {
    location.reload();
});
</script>
{% endraw %}
{% endblock %}
