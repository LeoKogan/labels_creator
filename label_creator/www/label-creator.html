{% extends "templates/web.html" %}

{% block title %}{{ title }}{% endblock %}

{% block page_content %}
<div class="container mt-4" style="max-width: 1200px;">
    <div class="row">
        <div class="col-md-12">
            <h1 class="mb-4">Label Creator</h1>
            <p class="text-muted">Upload CSV files to generate product labels with QR codes</p>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Upload CSV Files</h5>

                    <div class="upload-area p-4 text-center border rounded" style="border-style: dashed !important; background-color: #f8f9fa;">
                        <input type="file" id="fileInput" multiple accept=".csv" style="display: none;">
                        <label for="fileInput" style="cursor: pointer; margin: 0;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-cloud-upload mb-3" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383z"/>
                                <path fill-rule="evenodd" d="M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3z"/>
                            </svg>
                            <h5>Choose CSV Files</h5>
                            <p class="text-muted">or drag and drop here</p>
                        </label>
                    </div>

                    <div id="fileList" class="mt-3"></div>

                    <button id="uploadBtn" class="btn btn-primary mt-3" style="display: none;">
                        Process Files
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Section -->
    <div id="previewSection" class="row mt-4" style="display: none;">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Label Preview</h5>
                    <p>Total Labels: <strong id="totalLabels">0</strong></p>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="labelType" class="form-label">Label Type</label>
                            <select id="labelType" class="form-select">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped" id="previewTable">
                            <thead>
                                <tr>
                                    <th>SKU</th>
                                    <th>Product</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                </tr>
                            </thead>
                            <tbody id="previewTableBody">
                            </tbody>
                        </table>
                    </div>

                    <button id="generateBtn" class="btn btn-success">
                        Generate Labels (PDF)
                    </button>
                    <button id="startOverBtn" class="btn btn-secondary">
                        Start Over
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="row mt-4" style="display: none;">
        <div class="col-md-12 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Processing...</p>
        </div>
    </div>

    <!-- Success Section -->
    <div id="successSection" class="row mt-4" style="display: none;">
        <div class="col-md-12">
            <div class="alert alert-success" role="alert">
                <h4 class="alert-heading">âœ… Labels Generated Successfully!</h4>
                <p>Your PDF file is ready for download.</p>
                <hr>
                <div class="d-flex gap-2">
                    <a id="downloadLink" href="#" class="btn btn-success" download>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                        </svg>
                        Download PDF
                    </a>
                    <button id="generateAnotherBtn" class="btn btn-primary">
                        Generate Another
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% block style %}
<style>
.upload-area {
    transition: background-color 0.3s;
}
.upload-area:hover {
    background-color: #e9ecef !important;
}
.card {
    box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    border: 1px solid #e8e9ea;
}
</style>
{% endblock %}

<script>
let processedContent = [];

// Load label types on page load
frappe.ready(function() {
    loadLabelTypes();
});

async function loadLabelTypes() {
    try {
        const response = await frappe.call({
            method: 'label_creator.api.labels.get_label_types',
            args: {}
        });

        if (response.message && response.message.success) {
            const labelTypes = response.message.label_types;
            const select = document.getElementById('labelType');
            select.innerHTML = '';

            for (const [key, value] of Object.entries(labelTypes)) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${key} (${value.labels_per_row}x${value.labels_per_column})`;
                select.appendChild(option);
            }
        }
    } catch (error) {
        console.error('Error loading label types:', error);
        frappe.msgprint('Error loading label types');
    }
}

// File input handling
const fileInput = document.getElementById('fileInput');
const uploadBtn = document.getElementById('uploadBtn');
const fileList = document.getElementById('fileList');

fileInput.addEventListener('change', function() {
    if (this.files.length > 0) {
        fileList.innerHTML = '<ul class="list-group"></ul>';
        const ul = fileList.querySelector('ul');

        Array.from(this.files).forEach(file => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = file.name;
            ul.appendChild(li);
        });

        uploadBtn.style.display = 'block';
    } else {
        fileList.innerHTML = '';
        uploadBtn.style.display = 'none';
    }
});

// Upload and process
uploadBtn.addEventListener('click', async function() {
    const files = fileInput.files;
    if (files.length === 0) return;

    document.getElementById('loadingSpinner').style.display = 'block';

    try {
        const filesData = [];

        for (let file of files) {
            const content = await file.text();
            filesData.push({
                filename: file.name,
                content: content
            });
        }

        const response = await frappe.call({
            method: 'label_creator.api.labels.upload_and_process',
            args: {
                files_json: JSON.stringify(filesData)
            }
        });

        if (response.message && response.message.success) {
            processedContent = response.message.processed_content;
            displayPreview(processedContent, response.message.total_labels);
        } else {
            frappe.msgprint('Error processing files: ' + (response.message?.message || 'Unknown error'));
        }
    } catch (error) {
        console.error('Upload error:', error);
        frappe.msgprint('Error uploading files');
    } finally {
        document.getElementById('loadingSpinner').style.display = 'none';
    }
});

function displayPreview(content, totalLabels) {
    document.getElementById('totalLabels').textContent = totalLabels;

    const tbody = document.getElementById('previewTableBody');
    tbody.innerHTML = '';

    content.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${item.sku}</td>
            <td>${item.product}</td>
            <td>$${parseFloat(item.display_price).toFixed(2)}</td>
            <td>${item.quantity}</td>
        `;
        tbody.appendChild(tr);
    });

    document.getElementById('previewSection').style.display = 'block';
    window.scrollTo(0, document.body.scrollHeight);
}

// Generate labels
document.getElementById('generateBtn').addEventListener('click', async function() {
    const labelType = document.getElementById('labelType').value;

    if (!labelType) {
        frappe.msgprint('Please select a label type');
        return;
    }

    document.getElementById('loadingSpinner').style.display = 'block';

    try {
        const response = await frappe.call({
            method: 'label_creator.api.labels.generate_labels',
            args: {
                label_type: labelType,
                processed_content_json: JSON.stringify(processedContent)
            }
        });

        if (response.message && response.message.success) {
            // Show success section with download link
            const downloadLink = document.getElementById('downloadLink');
            downloadLink.href = response.message.file_url;
            downloadLink.download = response.message.filename || 'labels.pdf';

            document.getElementById('successSection').style.display = 'block';
            document.getElementById('previewSection').style.display = 'none';

            // Scroll to success section
            document.getElementById('successSection').scrollIntoView({ behavior: 'smooth' });
        } else {
            frappe.msgprint('Error generating labels: ' + (response.message?.message || 'Unknown error'));
        }
    } catch (error) {
        console.error('Generation error:', error);
        frappe.msgprint('Error generating labels');
    } finally {
        document.getElementById('loadingSpinner').style.display = 'none';
    }
});

// Start over
document.getElementById('startOverBtn').addEventListener('click', function() {
    location.reload();
});

// Generate another
document.getElementById('generateAnotherBtn').addEventListener('click', function() {
    document.getElementById('successSection').style.display = 'none';
    document.getElementById('previewSection').style.display = 'block';
    document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth' });
});
</script>
{% endblock %}
